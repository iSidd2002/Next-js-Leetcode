<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Final Authentication Persistence Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
        button { padding: 12px 20px; margin: 8px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        input { padding: 10px; margin: 5px; width: 200px; border: 1px solid #ddd; border-radius: 4px; }
        #results { white-space: pre-wrap; font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 4px; max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; }
        .critical { background: #fff5f5; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.pass { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.fail { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Final Authentication Persistence Test</h1>
        <p><strong>Purpose:</strong> Definitively diagnose authentication persistence issue</p>
        
        <div class="critical">
            <h3>ğŸš¨ CRITICAL ISSUE</h3>
            <p>Users report that refreshing the page (F5) shows the login modal again, despite being logged in.</p>
            <p><strong>Expected:</strong> Users stay logged in after page refresh</p>
            <p><strong>Actual:</strong> Login modal appears on refresh</p>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª Comprehensive Test</h2>
            <div>
                <input type="email" id="email" placeholder="Email" value="test@example.com">
                <input type="password" id="password" placeholder="Password" value="password123">
            </div>
            <div>
                <button class="btn-primary" onclick="runComprehensiveTest()">ğŸš€ Run Full Test</button>
                <button class="btn-success" onclick="testLogin()">ğŸ” Login Only</button>
                <button class="btn-warning" onclick="testAuthCheck()">ğŸ” Auth Check</button>
                <button class="btn-danger" onclick="clearAll()">ğŸ§¹ Clear</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š Test Results</h2>
            <div id="status"></div>
            <div id="results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ Manual Tests</h2>
            <ol>
                <li>Run the comprehensive test above</li>
                <li>If authentication works, open <a href="/" target="_blank">main app</a> in new tab</li>
                <li>Check if login modal appears (it should NOT)</li>
                <li>If login modal appears, refresh this page and check console logs</li>
            </ol>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }

        function setStatus(message, pass) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status ${pass ? 'pass' : 'fail'}">${pass ? 'âœ…' : 'âŒ'} ${message}</div>`;
        }

        function clearAll() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('status').innerHTML = '';
        }

        async function makeRequest(endpoint, options = {}) {
            const url = `/api${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers,
                },
                credentials: 'include', // Critical for HttpOnly cookies
                ...options,
            };

            try {
                log(`ğŸ“¡ ${config.method || 'GET'} ${endpoint}`, 'info');
                const response = await fetch(url, config);
                const data = await response.json();
                
                log(`ğŸ“¡ Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    log(`ğŸ“¡ Error data: ${JSON.stringify(data, null, 2)}`, 'error');
                }
                
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                log(`âŒ Network error: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testLogin() {
            log('ğŸ” TESTING LOGIN', 'info');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const result = await makeRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (result.success) {
                log('âœ… Login successful - HttpOnly cookies set', 'success');
                return true;
            } else {
                log('âŒ Login failed', 'error');
                return false;
            }
        }

        async function testAuthCheck() {
            log('ğŸ” TESTING AUTHENTICATION CHECK', 'info');
            log('This simulates what the app does on page load...', 'info');
            
            const result = await makeRequest('/auth/profile');
            
            if (result.success) {
                log('âœ… Authentication check PASSED', 'success');
                log('âœ… User should NOT see login modal', 'success');
                return true;
            } else {
                log('âŒ Authentication check FAILED', 'error');
                log('âŒ User WILL see login modal', 'error');
                log(`Error: ${result.data?.error || 'Unknown'}`, 'error');
                return false;
            }
        }

        async function runComprehensiveTest() {
            clearAll();
            log('ğŸš€ COMPREHENSIVE AUTHENTICATION PERSISTENCE TEST', 'info');
            log('=' .repeat(60), 'info');
            
            // Test 1: Initial state
            log('1ï¸âƒ£ Testing initial authentication state...', 'info');
            const initialAuth = await testAuthCheck();
            
            if (!initialAuth) {
                log('âŒ Not authenticated initially, proceeding with login...', 'info');
                
                // Test 2: Login
                log('\n2ï¸âƒ£ Testing login process...', 'info');
                const loginSuccess = await testLogin();
                
                if (!loginSuccess) {
                    setStatus('Login failed - cannot continue test', false);
                    return;
                }
                
                // Wait for cookies to be processed
                log('â³ Waiting for cookies to be processed...', 'info');
                await new Promise(resolve => setTimeout(resolve, 2000));
            } else {
                log('âœ… Already authenticated, skipping login', 'success');
            }
            
            // Test 3: Post-login authentication
            log('\n3ï¸âƒ£ Testing authentication after login...', 'info');
            const postLoginAuth = await testAuthCheck();
            
            if (!postLoginAuth) {
                setStatus('Authentication failed after login - this is the bug!', false);
                log('ğŸš¨ CRITICAL: Authentication does not work after login', 'error');
                return;
            }
            
            // Test 4: Simulate page refresh
            log('\n4ï¸âƒ£ Simulating page refresh (waiting 3 seconds)...', 'info');
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            log('Testing authentication after simulated refresh...', 'info');
            const refreshAuth = await testAuthCheck();
            
            if (refreshAuth) {
                setStatus('âœ… AUTHENTICATION PERSISTENCE IS WORKING!', true);
                log('ğŸ‰ SUCCESS: Authentication persists after refresh', 'success');
                log('ğŸ‰ Users should NOT see login modal on refresh', 'success');
            } else {
                setStatus('âŒ AUTHENTICATION PERSISTENCE IS BROKEN!', false);
                log('ğŸš¨ FAILURE: Authentication lost after refresh', 'error');
                log('ğŸš¨ This is why users see login modal on refresh', 'error');
            }
            
            // Test 5: Final recommendations
            log('\n5ï¸âƒ£ NEXT STEPS:', 'info');
            if (refreshAuth) {
                log('âœ… API-level authentication is working correctly', 'success');
                log('ğŸ” If users still see login modal, check app initialization', 'warning');
                log('ğŸ” Open main app and check browser console for errors', 'warning');
            } else {
                log('âŒ API-level authentication is failing', 'error');
                log('ğŸ”§ Check middleware configuration', 'error');
                log('ğŸ”§ Check cookie attributes and browser security', 'error');
                log('ğŸ”§ Check server logs for authentication errors', 'error');
            }
        }

        // Auto-start when page loads
        window.addEventListener('load', () => {
            log('ğŸ” Final Authentication Persistence Test loaded', 'info');
            log(`Running from: ${window.location.origin}`, 'info');
            log('Click "Run Full Test" to start comprehensive testing', 'info');
        });
    </script>
</body>
</html>
