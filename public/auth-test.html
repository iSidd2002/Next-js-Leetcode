<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Same-Origin Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Same-Origin Authentication Test</h1>
        <p><strong>Running from:</strong> http://localhost:3000/auth-test.html</p>
        <p><strong>API calls to:</strong> http://localhost:3000/api/*</p>
        
        <div class="step info">
            <h3>Step 1: Login</h3>
            <input type="email" id="email" value="test@example.com" placeholder="Email">
            <input type="password" id="password" value="password123" placeholder="Password">
            <button onclick="doLogin()">Login</button>
        </div>
        
        <div class="step info">
            <h3>Step 2: Test Authentication</h3>
            <button onclick="testAuth()">Test Auth Status</button>
            <button onclick="testProfile()">Test Profile</button>
        </div>
        
        <div class="step info">
            <h3>Step 3: Test App Initialization</h3>
            <button onclick="testAppInit()">Simulate App Init</button>
            <button onclick="window.location.reload()">Real Refresh</button>
        </div>
        
        <div class="step">
            <h3>Debug Log</h3>
            <div id="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function makeRequest(endpoint, options = {}) {
            const url = `/api${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers,
                },
                credentials: 'include', // Include HttpOnly cookies
                ...options,
            };

            try {
                log(`Making request: ${config.method || 'GET'} ${endpoint}`);
                log(`Full URL: ${window.location.origin}${url}`);
                log(`Credentials: ${config.credentials}`);
                log(`Visible cookies: ${document.cookie || 'none (HttpOnly cookies are invisible)'}`);
                
                const response = await fetch(url, config);
                
                log(`Response: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                log(`Data: ${JSON.stringify(data, null, 2)}`);
                
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                log(`Error: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        async function doLogin() {
            log('=== STARTING LOGIN ===');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const result = await makeRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (result.success) {
                log('‚úÖ Login successful!');
                log('HttpOnly cookies should now be set by server');
                
                // Wait a moment for cookies to be processed
                setTimeout(() => {
                    log(`Cookies after login: ${document.cookie || 'none visible (HttpOnly)'}`);
                }, 1000);
            } else {
                log('‚ùå Login failed!');
            }
        }

        async function testAuth() {
            log('=== TESTING AUTH STATUS ===');
            
            // This replicates ApiService.checkAuthStatus()
            const result = await makeRequest('/auth/profile');
            
            if (result.success) {
                log('‚úÖ Authentication check PASSED');
                log('‚úÖ User should NOT see login modal');
                return true;
            } else {
                log('‚ùå Authentication check FAILED');
                log('‚ùå User WILL see login modal');
                log(`Error: ${result.data?.error || 'Unknown error'}`);
                return false;
            }
        }

        async function testProfile() {
            log('=== TESTING PROFILE ENDPOINT ===');
            const result = await makeRequest('/auth/profile');
            
            if (result.success) {
                log('‚úÖ Profile request successful');
                log(`User: ${result.data.email}`);
            } else {
                log('‚ùå Profile request failed');
                log(`Error: ${result.data?.error || 'Unknown error'}`);
            }
        }

        async function testAppInit() {
            log('=== SIMULATING APP INITIALIZATION ===');
            log('This replicates what happens when the app loads...');
            
            // Step 1: Check auth status (what initializeApp does)
            log('Step 1: Checking authentication status...');
            const isAuthenticated = await testAuth();
            
            if (isAuthenticated) {
                log('‚úÖ App would load user data and show main interface');
                log('‚úÖ NO LOGIN MODAL would appear');
            } else {
                log('‚ùå App would show login modal');
                log('‚ùå This is the bug we are trying to fix');
            }
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            log('üîç Same-Origin Auth Test loaded');
            log(`Origin: ${window.location.origin}`);
            log(`Protocol: ${window.location.protocol}`);
            log('This test runs from the same origin as the API');
            log('Follow the steps above to test authentication');
        });
    </script>
</body>
</html>
